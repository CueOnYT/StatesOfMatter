<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>States of Matter By Devin</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            width: 100%;
            padding: 40px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1 {
            font-size: 2em;
            font-weight: 500;
            margin-bottom: 30px;
            text-align: center;
            color: #1a73e8;
        }
        #simulation {
            border: 1px solid #ddd;
            width: 100%;
            height: 450px;
            position: relative;
            background-color: #ffffff;
            margin: 0 auto 20px;
            border-radius: 8px;
            overflow: hidden;
        }
        #canvas {
            width: 100%;
            height: 100%;
        }
        #thermometer {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background: #1a73e8;
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 10;
        }
        #current-state {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background: #34a853;
            padding: 6px 12px;
            border-radius: 20px;
            z-index: 10;
        }
        #pressure {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            background: #ff9800;
            padding: 4px 8px;
            border-radius: 10px;
            z-index: 10;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #555;
        }
        select, input[type="range"], button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        select:focus, input[type="range"]:focus, button:focus {
            border-color: #1a73e8;
            outline: none;
        }
        input[type="range"] {
            width: 200px;
            accent-color: #1a73e8;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
        }
        button:hover {
            background: #0d65d8;
        }
        #info {
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        #info h2 {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }
        #info p {
            margin: 5px 0;
        }
        #info .equation {
            font-family: monospace;
            background: #e8f4f8;
            padding: 5px;
            border-radius: 4px;
            color: #0066cc;
        }
        #chart-container {
            height: 300px;
            margin-top: 20px;
        }
        @media (max-width: 600px) {
            .container {
                padding: 20px 10px;
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            input[type="range"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>States of Matter Simulation - Upgraded Edition</h1>
        <p style="text-align: center; color: #666;">Original by Devin for Mr. Wilson. Enhanced with more substances, accurate physics, proper collisions, velocity distribution chart, and more.</p>
        <div id="simulation">
            <canvas id="canvas"></canvas>
            <div id="thermometer">100 K</div>
            <div id="current-state">Solid</div>
            <div id="pressure">Pressure: 0 kPa</div>
        </div>
        <div class="controls">
            <label for="substance">Substance:
                <select id="substance" onchange="updateSimulation()">
                    <option value="helium">Helium</option>
                    <option value="hydrogen">Hydrogen</option>
                    <option value="neon">Neon</option>
                    <option value="nitrogen">Nitrogen</option>
                    <option value="oxygen">Oxygen</option>
                    <option value="argon">Argon</option>
                    <option value="krypton">Krypton</option>
                    <option value="carbonDioxide">Carbon Dioxide</option>
                    <option value="water">Water</option>
                    <option value="ethanol">Ethanol</option>
                    <option value="mercury">Mercury</option>
                    <option value="iron">Iron</option>
                </select>
            </label>
            <label for="temperature">Temperature (K):
                <input type="range" id="temperature" min="0" max="4000" value="100" oninput="updateTemperature()">
            </label>
            <button onclick="heatUp()">Heat (+10 K)</button>
            <button onclick="coolDown()">Cool (-10 K)</button>
            <button onclick="togglePause()">Pause/Play</button>
            <button onclick="resetSimulation()">Reset</button>
        </div>
        <div id="info">
            <p>Average Kinetic Energy (simulated): <span id="avg-ke">0</span></p>
        </div>
        <div id="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = 450;

        const chartCtx = document.getElementById('chart').getContext('2d');
        const myChart = new Chart(chartCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Velocity Distribution',
                    data: [],
                    backgroundColor: '#1a73e8'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Velocity Histogram (Gas State Only)'
                    }
                }
            }
        });

        // Updated substances with accurate data
        const substances = {
            helium: { melting: 0.95, boiling: 4.22, color: '#ff00ff', molarMass: 0.004 },
            hydrogen: { melting: 13.99, boiling: 20.27, color: '#ffff00', molarMass: 0.002 },
            neon: { melting: 24.56, boiling: 27.1, color: '#ff4500', molarMass: 0.020 },
            nitrogen: { melting: 63.23, boiling: 77.36, color: '#9900ff', molarMass: 0.028 },
            oxygen: { melting: 54.36, boiling: 90.19, color: '#0000ff', molarMass: 0.032 },
            argon: { melting: 83.81, boiling: 87.3, color: '#00ff00', molarMass: 0.04 },
            krypton: { melting: 115.78, boiling: 119.93, color: '#00ff99', molarMass: 0.084 },
            carbonDioxide: { melting: 216.55, boiling: 194.68, color: '#ffffff', molarMass: 0.044 },
            water: { melting: 273.15, boiling: 373.15, color: '#00ffff', molarMass: 0.018 },
            ethanol: { melting: 159, boiling: 351.4, color: '#ff9900', molarMass: 0.046 },
            mercury: { melting: 234.32, boiling: 629.88, color: '#a9a9a9', molarMass: 0.201 },
            iron: { melting: 1811, boiling: 3134, color: '#666666', molarMass: 0.056 }
        };

        let currentSubstance = 'neon';
        let temperature = 100;
        let particles = [];
        const numParticles = 150;
        const particleRadius = 3;
        let isPaused = false;
        let pressure = 0;
        let frame = 0;

        class Particle {
            constructor(x, y, vx = (Math.random() - 0.5) * 0.5, vy = (Math.random() - 0.5) * 0.5) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.baseX = x;
                this.baseY = y;
                this.forceX = 0;
                this.forceY = 0;
            }
        }

        function initParticles() {
            particles = [];
            const gridSize = Math.ceil(Math.sqrt(numParticles));
            const spacing = Math.min(canvas.width, canvas.height) / (gridSize + 1);
            for (let i = 0; i < numParticles; i++) {
                const row = Math.floor(i / gridSize);
                const col = i % gridSize;
                const x = (col + 1) * spacing;
                const y = canvas.height - (row + 1) * spacing + (Math.random() - 0.5) * spacing * 0.1;
                particles.push(new Particle(x, y));
            }
        }

        function getState(temp, subst) {
            if (currentSubstance === 'carbonDioxide') {
                return temp < subst.boiling ? 'solid' : 'gas';
            }
            if (temp < subst.melting) return 'solid';
            if (temp < subst.boiling) return 'liquid';
            return 'gas';
        }

        function ljForce(dist, epsilon = 1, sigma = 10) {
            if (dist === 0) return 0;
            const sr6 = Math.pow(sigma / dist, 6);
            const forceMag = 24 * epsilon / dist * (2 * sr6 * sr6 - sr6) * 0.01; // Reduced force magnitude
            return forceMag;
        }

        function updateSimulation() {
            currentSubstance = document.getElementById('substance').value;
            const subst = substances[currentSubstance];
            const state = getState(temperature, subst);
            document.getElementById('current-state').textContent = state.charAt(0).toUpperCase() + state.slice(1);
            document.getElementById('info').innerHTML = `
                <h2>${currentSubstance.replace(/([A-Z])/g, ' $1').trim()}</h2>
                <p>Current State: ${state.charAt(0).toUpperCase() + state.slice(1)}</p>
                <p>Melting Point: ${subst.melting.toFixed(2)} K</p>
                <p>Boiling Point: ${subst.boiling.toFixed(2)} K</p>
                <p>Molar Mass: ${subst.molarMass} kg/mol</p>
                <p>Average Kinetic Energy (simulated): <span id="avg-ke">0</span></p>
                <p>In the ${state} state, particles exhibit behaviors governed by the kinetic theory. Kinetic energy: <span class="equation">KE = (1/2) m v^2</span> averaged over particles.</p>
                ${state === 'gas' ? `<p>Ideal gas law: <span class="equation">P V = n R T</span>. Velocity distribution approximates Maxwell-Boltzmann.</p>` : ''}
                ${state === 'liquid' ? `<p>Intermolecular forces modeled by Lennard-Jones potential: <span class="equation">U = 4ε [(σ/r)^12 - (σ/r)^6]</span>.</p>` : ''}
                ${state === 'solid' ? `<p>Vibrations modeled as harmonic oscillators: <span class="equation">F = -k x</span>.</p>` : ''}
                <p>Collisions are elastic, conserving momentum and energy.</p>
                <p>Other physical functions: Newton's laws <span class="equation">F = m a</span>, work-energy theorem, etc., underlie the simulation dynamics.</p>
            `;
            initParticles();
        }

        function updateTemperature() {
            temperature = parseInt(document.getElementById('temperature').value);
            document.getElementById('thermometer').textContent = `${temperature} K`;
            updateSimulation();
        }

        function heatUp() {
            temperature = Math.min(4000, temperature + 10);
            document.getElementById('temperature').value = temperature;
            updateTemperature();
        }

        function coolDown() {
            temperature = Math.max(0, temperature - 10);
            document.getElementById('temperature').value = temperature;
            updateTemperature();
        }

        function togglePause() {
            isPaused = !isPaused;
            if (!isPaused) animate();
        }

        function resetSimulation() {
            temperature = 100;
            document.getElementById('temperature').value = temperature;
            currentSubstance = 'neon';
            document.getElementById('substance').value = 'neon';
            isPaused = false;
            updateSimulation();
            animate();
        }

        function handleCollision(p1, p2) {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 2 * particleRadius && dist > 0) {
                const nx = dx / dist;
                const ny = dy / dist;
                const dvx = p1.vx - p2.vx;
                const dvy = p1.vy - p2.vy;
                const dot = dvx * nx + dvy * ny;
                if (dot < 0) {
                    p1.vx -= dot * nx * 0.5; // Reduced collision impact
                    p1.vy -= dot * ny * 0.5;
                    p2.vx += dot * nx * 0.5;
                    p2.vy += dot * ny * 0.5;
                }
                const overlap = 2 * particleRadius - dist;
                p1.x += nx * overlap / 2;
                p1.y += ny * overlap / 2;
                p2.x -= nx * overlap / 2;
                p2.y -= ny * overlap / 2;
            }
        }

        function animate() {
            if (isPaused) return;
            frame++;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const subst = substances[currentSubstance];
            const state = getState(temperature, subst);
            const speedFactor = Math.sqrt(temperature / 273) * 0.5; // Reduced speed factor
            const vibrationAmp = Math.min(4, (temperature / subst.melting) * 1.5); // Reduced vibration

            particles.forEach(p => { p.forceX = 0; p.forceY = 0; });

            const epsilon = state === 'solid' ? 1.5 : state === 'liquid' ? 1.0 : 0.3; // Adjusted force strength
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 50 && dist > 0) {
                        const forceMag = ljForce(dist, epsilon);
                        const fx = (dx / dist) * forceMag;
                        const fy = (dy / dist) * forceMag;
                        particles[i].forceX += fx;
                        particles[i].forceY += fy;
                        particles[j].forceX -= fx;
                        particles[j].forceY -= fy;
                    }
                    handleCollision(particles[i], particles[j]);
                }
            }

            let wallCollisions = 0;
            let sumKE = 0;

            particles.forEach(p => {
                p.vx += p.forceX * 0.005 + (Math.random() - 0.5) * 0.02; // Reduced force and noise
                p.vy += p.forceY * 0.005 + (Math.random() - 0.5) * 0.02;

                if (state === 'solid') {
                    const dx = p.x - p.baseX;
                    const dy = p.y - p.baseY;
                    p.forceX -= dx * 0.05; // Reduced spring constant
                    p.forceY -= dy * 0.05;
                    p.vx += p.forceX * 0.005;
                    p.vy += p.forceY * 0.005;
                    p.x += (Math.random() - 0.5) * vibrationAmp;
                    p.y += (Math.random() - 0.5) * vibrationAmp;
                } else if (state === 'liquid') {
                    p.vy += 0.05; // Reduced gravity
                    p.vx *= 0.98; // Increased damping
                    p.vy *= 0.98;
                    p.x += p.vx;
                    p.y += p.vy;
                } else {
                    p.x += p.vx * speedFactor;
                    p.y += p.vy * speedFactor;
                }

                // Wall collisions
                if (p.x - particleRadius < 0) { p.x = particleRadius; p.vx = -p.vx * 0.8; wallCollisions++; } // Reduced bounce
                if (p.x + particleRadius > canvas.width) { p.x = canvas.width - particleRadius; p.vx = -p.vx * 0.8; wallCollisions++; }
                if (p.y - particleRadius < 0) { p.y = particleRadius; p.vy = -p.vy * 0.8; wallCollisions++; }
                if (p.y + particleRadius > canvas.height) { p.y = canvas.height - particleRadius; p.vy = -p.vy * (state === 'liquid' ? 0.2 : 0.8); wallCollisions++; }

                sumKE += 0.5 * (p.vx * p.vx + p.vy * p.vy);
            });

            const avgKE = sumKE / numParticles;
            if (document.getElementById('avg-ke')) document.getElementById('avg-ke').textContent = avgKE.toFixed(2);

            // Pressure heuristic
            if (state === 'gas') {
                pressure = wallCollisions * speedFactor * 0.2; // Reduced pressure scaling
            } else {
                pressure = 0;
            }
            document.getElementById('pressure').textContent = `Pressure: ${pressure.toFixed(1)} (arb. units)`;

            // Draw particles
            particles.forEach(p => {
                const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, particleRadius);
                gradient.addColorStop(0, subst.color);
                gradient.addColorStop(1, '#00000033');
                ctx.beginPath();
                ctx.arc(p.x, p.y, particleRadius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            });

            // Update chart for gas state
            if (state === 'gas' && frame % 10 === 0) {
                const speeds = particles.map(p => Math.sqrt(p.vx * p.vx + p.vy * p.vy) * speedFactor);
                const maxSpeed = Math.max(...speeds, 1);
                const bins = 10;
                const binSize = maxSpeed / bins;
                const hist = new Array(bins).fill(0);
                speeds.forEach(s => {
                    let bin = Math.floor(s / binSize);
                    if (bin >= bins) bin = bins - 1;
                    hist[bin]++;
                });
                myChart.data.labels = hist.map((_, i) => `${(i * binSize).toFixed(1)} - ${((i + 1) * binSize).toFixed(1)}`);
                myChart.data.datasets[0].data = hist;
                myChart.update();
            } else if (frame % 10 === 0) {
                myChart.data.datasets[0].data = [];
                myChart.update();
            }

            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', () => {
            canvas.width = canvas.parentElement.clientWidth;
            initParticles();
        });

        initParticles();
        updateSimulation();
        animate();
    </script>
</body>
</html>
